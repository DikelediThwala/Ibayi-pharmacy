@model IEnumerable<IBayiLibrary.Models.Domain.tblOrder>
@{
    ViewData["Title"] = "Pack Orders";
    Layout = "PharmacistLayout";   
}
<form method="get" asp-action="Pack" class="d-flex mb-4">
    <input type="text" name="searchQuery"
           value="@Context.Request.Query["searchQuery"]"
           class="form-control me-2"
           placeholder="Search by Name or Order ID..." />
    <button type="submit" class="btn btn-primary">Search</button>
</form>
@if (!Model.Any())
{
    <div class="alert alert-warning text-center">
        No orders found matching your search.
    </div>
}

@foreach (var orderGroup in Model.GroupBy(o => o.OrderID))
{
    var first = orderGroup.First();
    var total = orderGroup.Sum(x => x.Quantity * x.SalesPrice);
    var vat = total * 0.15M;

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Order #: @first.OrderID</h5>
                <span><h5 class="card-title mb-0">Name: @first.FirstName @first.LastName</h5></span>
            </div>

            <p class="text-muted mb-2">Date Placed: @first.DatePlaced?.ToString("yyyy-MM-dd")</p>

            <form asp-action="UpdatePackOrders" method="post">
                <table class="table table-striped table-bordered mt-3">
                    <thead class="table-primary text-center">
                        <tr>
                            <th></th>
                            <th>Medicine</th>
                            <th>Quantity</th>
                            <th>Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in orderGroup)
                        {
                            <tr>
                                <td>
                                    <!-- Name must match parameter in controller -->
                                    <input type="checkbox" name="medicineIds" class="form-check-input"
                                           value="@item.OrderLineID" />

                                </td>
                                <td>@item.MedicineName</td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-end">R @item.SalesPrice.ToString("0.00")</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="d-flex justify-content-end mt-2">
                    <p class="mb-0 me-3"><strong>Total:</strong> R @total.ToString("0.00")</p>
                    <p class="mb-0"><strong>VAT (15%):</strong> R @vat.ToString("0.00")</p>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-success me-2">Pack Order</button>
                </div>
            </form>

        </div>
    </div>
}

