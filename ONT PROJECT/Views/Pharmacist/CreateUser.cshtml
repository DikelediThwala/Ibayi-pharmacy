@using System.Web
@model IBayiLibrary.Models.Domain.tblUser
@{
    ViewData["Title"] = "Manage Users";
    Layout = "PharmacistLayout";
    var returnUrl = ViewData["ReturnUrl"] as string ?? "";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

@if (TempData["ErrorMessage"] != null)
{
    <div id="errorAlert" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-dark">
        <i class="bi bi-hospital me-2 text-primary"></i> Register User
    </h2>
</div>

<hr style="height: 4px; background-color: #011425; border: none;" />

<div class="alert alert-info shadow-sm d-flex align-items-center gap-2">
    <i class="bi bi-info-circle-fill"></i>
    Please ensure all details are accurate before saving. Fields marked with <span class="text-danger">*</span> are required.
</div>

<!-- Form Card -->
<div class="card shadow p-4">
    <div class="card-body">
        <form asp-action="CreateUser" enctype="multipart/form-data" method="post" id="userForm">
            <input type="hidden" name="returnUrl" value="@returnUrl" />
            <h2>Personal Details</h2>
            <hr />
            <div class="row mb-4">
                <div class="col-md-6">
                    <label asp-for="Title" class="form-label">Title <span class="text-danger">*</span></label>
                    <select asp-for="Title" class="form-select" id="Title" required>
                        <option value="">-- Select Title --</option>
                        <option value="Mr.">Mr.</option>
                        <option value="Mrs.">Mrs.</option>
                        <option value="Miss">Miss</option>
                        <option value="Dr.">Dr.</option>
                    </select>
                    <span asp-validation-for="Title" class="text-danger small"></span>
                </div>
                <div class="col-md-6">
                <label asp-for="IDNumber" class="form-label">
                    ID Number <span class="text-danger">*</span>
                </label>
                <input asp-for="IDNumber" id="IDNumber" class="form-control" placeholder="e.g., 1234567890123" required />
                <span asp-validation-for="IDNumber" class="text-danger small"></span>
                <div class="invalid-feedback" id="idNumberFeedback"></div>
            </div>

            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <label asp-for="FirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                    <input asp-for="FirstName" class="form-control" id="FirstName" placeholder="e.g., Dikeledi" required />
                    <span asp-validation-for="FirstName" class="text-danger small"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="LastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                    <input asp-for="LastName" class="form-control" id="LastName" placeholder="e.g., Thwala" required />
                    <span asp-validation-for="LastName" class="text-danger small"></span>
                </div>
            </div>

            <h2>Contact Details</h2>
            <hr />
            <div class="row mb-4">
                <div class="col-md-6">
                    <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                    <input asp-for="Email" class="form-control" id="Email" type="email" placeholder="e.g., user@example.com" required />
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="PhoneNumber" class="form-label">Contact Number <span class="text-danger">*</span></label>
                    <input asp-for="PhoneNumber" id="PhoneNumber" class="form-control" placeholder="e.g., 012 345 6789" required />
                    <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                </div>
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-primary" id="btnBack">
                    <i class="bi bi-arrow-left"></i> Back
                </button>

                <button type="submit" class="btn btn-success btn-sm">
                    <i class="bi bi-save me-1"></i> Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Validation Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Allow only letters for first & last names
    function allowOnlyLetters(event) {
        if (!/^[a-zA-Z]$/.test(event.key)) event.preventDefault();
    }
    document.getElementById("FirstName").addEventListener("keypress", allowOnlyLetters);
    document.getElementById("LastName").addEventListener("keypress", allowOnlyLetters);

    // Allow only digits for IDNumber and PhoneNumber
    function allowOnlyDigits(event) {
        if (!/[0-9]/.test(event.key)) event.preventDefault();
    }
    document.getElementById("IDNumber").addEventListener("keypress", allowOnlyDigits);
    document.getElementById("PhoneNumber").addEventListener("keypress", allowOnlyDigits);

    // Helper: AJAX check for Email or IDNumber
    async function checkIfExists(field, value) {
        const url = field === "email"
            ? `/Pharmacist/CheckEmailExists?email=${encodeURIComponent(value)}`
            : `/Pharmacist/CheckIDNumberExists?idNumber=${encodeURIComponent(value)}`;
        const response = await fetch(url);
        if (!response.ok) return false;
        const data = await response.json();
        return data.exists;
    }

    // Real-time IDNumber check
    const idInput = document.getElementById("IDNumber");
    const idFeedback = document.createElement("div");
    idFeedback.classList.add("invalid-feedback");
    idInput.parentNode.appendChild(idFeedback);

    let idNumberValid = false;
    idInput.addEventListener("blur", async function () {
        const value = idInput.value.trim();
        if (!value) return;
        const exists = await checkIfExists("idNumber", value);
        if (exists) {
            idInput.classList.add("is-invalid");
            idFeedback.textContent = "This ID Number is already registered.";
            idNumberValid = false;
        } else {
            idInput.classList.remove("is-invalid");
            idFeedback.textContent = "";
            idNumberValid = true;
        }
    });

    // Form submission validation
    document.getElementById("userForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const requiredFields = ["Title", "IDNumber", "FirstName", "LastName", "Email", "PhoneNumber"];
        let isValid = true;

        requiredFields.forEach(id => {
            const field = document.getElementById(id);
            if (!field.value.trim()) {
                field.classList.add("is-invalid");
                isValid = false;
            } else {
                field.classList.remove("is-invalid");
            }
        });

        // Phone number validation (starts with 0, 10 digits)
        const phoneInput = document.getElementById("PhoneNumber");
        const phoneValue = phoneInput.value.trim();
        if (!/^0\d{9}$/.test(phoneValue)) {
            phoneInput.classList.add("is-invalid");
            alert("❌ Phone number must start with 0 and be exactly 10 digits.");
            return;
        } else {
            phoneInput.classList.remove("is-invalid");
        }

        if (!isValid) {
            alert("❌ Please fill in all required fields.");
            return;
        }

        // Email duplicate check via AJAX
        const emailInput = document.getElementById("Email");
        const emailValue = emailInput.value.trim();
        if (await checkIfExists("email", emailValue)) {
            emailInput.classList.add("is-invalid");
            alert("❌ This email address already exists. Please use a different one.");
            emailInput.focus();
            return;
        }

        // IDNumber validity
        if (!idNumberValid) {
            idInput.classList.add("is-invalid");
            alert("❌ This ID Number already exists. Please use a different one.");
            idInput.focus();
            return;
        }

        // ✅ All checks passed, submit form
        this.submit();
    });
});
</script>


@section Scripts {
    <script>
        (function() {
            var returnUrl = '@Html.Raw(HttpUtility.JavaScriptStringEncode(returnUrl))';
            var btn = document.getElementById('btnBack');

            if (returnUrl && returnUrl.length > 0) {
                // Use location.href so the browser navigates to the desired page
                btn.addEventListener('click', function() {
                    // If for some reason the returnUrl is not local, fallback to history.back()
                    try {
                        // Simple local check — adjust server-side if needed
                        var isLocal = returnUrl.indexOf(window.location.origin) === 0 || returnUrl.indexOf('/') === 0;
                        if (isLocal) {
                            window.location.href = returnUrl;
                        } else {
                            history.back();
                        }
                    } catch (e) {
                        history.back();
                    }
                });
            } else {
                // No returnUrl — just go back in history
                btn.addEventListener('click', function() { history.back(); });
            }
        })();
    </script>
}


