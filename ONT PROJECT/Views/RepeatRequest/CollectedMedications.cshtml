@model List<ONT_PROJECT.Models.OrderLine>

@{
    ViewData["Title"] = "Collected Medications";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<div class="container-xl">
    <div class="table-wrapper">
        <div class="table-title">
            <h2>Collected <b>Medications</b></h2>
        </div>

        @if (!Model.Any())
        {
            <p class="text-muted">No collected medications found.</p>
        }
        else
        {
            <table class="table table-striped table-hover">
                <thead class="table-primary">
                    <tr>
                        <th>Medication</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Line Total</th>
                        <th>Order #</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var line in Model)
                    {
                        <tr>
                            <td>@(line.Medicine?.MedicineName ?? "Unknown")</td>
                            <td>@line.Quantity</td>
                            <td>@($"R{line.Price:0.00}")</td>
                            <td>@($"R{line.LineTotal:0.00}")</td>
                            <td>@line.OrderId</td>
                            <td>
                                <button type="button"
                                        class="btn btn-warning btn-sm request-repeat-btn"
                                        data-line-id="@line.OrderLineId">
                                    Request Repeat
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.request-repeat-btn').click(function () {
            var btn = $(this);
            var lineId = btn.data('line-id');

            btn.prop('disabled', true).text('Requesting...');

            $.ajax({
                url: '@Url.Action("AjaxRequestRepeat", "RepeatRequest")',
                type: 'POST',
                data: {
                    orderLineId: lineId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (resp) {
                    alert(resp.message);
                    btn.prop('disabled', false).text('Request Repeat');
                },
                error: function () {
                    alert('Something went wrong.');
                    btn.prop('disabled', false).text('Request Repeat');
                }
            });
        });
    });
</script>
