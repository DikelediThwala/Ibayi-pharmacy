@using ONT_PROJECT.Models
@inject ApplicationDbContext _context

@{
    ViewData["Title"] = ViewData["Title"] ?? "Ibayi Pharmacy";

    // Get logged-in user email from session
    var email = Context.Session.GetString("UserEmail");
    string profilePicSrc = Url.Content("~/images/register/default-profile.png"); // fallback default
    string userFirstName = Context.Session.GetString("UserFirstName") ?? "";
    string userLastName = Context.Session.GetString("UserLastName") ?? "";

    if (!string.IsNullOrEmpty(email))
    {
        var user = _context.TblUsers.FirstOrDefault(u => u.Email == email);
        if (user != null)
        {
            userFirstName = user.FirstName;
            userLastName = user.LastName;

            if (user.ProfilePicture != null && user.ProfilePicture.Length > 0)
            {
                var base64 = Convert.ToBase64String(user.ProfilePicture);
                profilePicSrc = $"data:image/png;base64,{base64}";
            }
        }
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - Ibayi Pharmacy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', sans-serif;
        }

        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 250px;
            background-color: #011425;
            color: white;
            z-index: 1000;
            transition: width 0.3s;
        }

            .sidebar.collapsed {
                width: 80px;
            }

            .sidebar .nav-link {
                color: #5C7C89;
                white-space: nowrap;
                display: flex;
                align-items: center;
                gap: 10px;
                border-radius: 4px;
                padding: 8px 12px;
            }

                .sidebar .nav-link:hover, .sidebar .nav-link.active {
                    background-color: #1F4959;
                    color: white;
                }

            .sidebar.collapsed .nav-link span {
                display: none;
            }

            .sidebar .profile-header {
                padding: 1rem;
                display: flex;
                align-items: center;
                gap: 10px;
                border-bottom: 1px solid rgba(255,255,255,0.2);
            }

            .sidebar.collapsed .profile-text {
                display: none;
            }

            .sidebar .profile-text div {
                color: cadetblue;
                font-size: 0.9rem;
            }

        .collapse-button {
            cursor: pointer;
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            color: #5C7C89;
            transition: all 0.3s ease;
        }

            .collapse-button:hover {
                background-color: #1F4959;
                color: white;
            }

        .main {
            margin-left: 250px;
            transition: margin-left 0.3s;
        }

        .sidebar.collapsed ~ .main {
            margin-left: 80px;
        }

        .top-navbar {
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-area {
            padding: 2rem;
        }

        .img-fluid {
            width: 150px;
            height: 60px;
            margin-top: 10px;
        }

        .dropdown-menu {
            min-width: 180px;
        }

            .dropdown-menu .dropdown-item i {
                font-size: 1rem;
            }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="profile-header">
            <img src="@profilePicSrc"
                 alt="Profile Picture"
                 style="width:70px; height:70px; object-fit:cover; border-radius:50%;" />
            <div class="profile-text ms-2">
                @userFirstName @userLastName
                <div>Customer</div>
            </div>
        </div>


        <div class="collapse-button" onclick="toggleSidebar()">
            <i class="bi bi-list fs-4" id="collapse-icon"></i>
        </div>

        <ul class="nav flex-column p-2 mt-2">
            <li class="nav-item"><a class="nav-link active" asp-controller="Customer" asp-action="Dashboard"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
            <li class="nav-item"><a class="nav-link" asp-controller="Prescription" asp-action="Upload"><i class="bi bi-file-earmark-medical"></i> <span>Upload Prescription</span></a></li>
            <li class="nav-item"><a class="nav-link" asp-controller="CustomerPrescription" asp-action="MyPrescriptions"><i class="bi bi-journal-medical"></i> <span>My Prescriptions</span></a></li>
            <li class="nav-item"><a class="nav-link" asp-controller="CustomerPrescriptionLine" asp-action="MyPrescriptionLines"><i class="bi bi-capsule"></i> <span>Order Medication</span></a></li>
            <li class="nav-item"><a class="nav-link" asp-controller="CustomerOrder" asp-action="OrderedMedication"><i class="bi bi-basket3"></i> <span>Ordered Medication</span></a></li>
            <li class="nav-item"><a class="nav-link" asp-controller="RepeatRequest" asp-action="CollectedMedications"><i class="bi bi-truck"></i> <span>Collected Medications</span></a></li>
            <li class="nav-item"><a class="nav-link" asp-controller="CustomerReport" asp-action="Index"><i class="bi bi-file-earmark-text"></i> <span>Reports</span></a></li>
            <li class="nav-item"><a class="nav-link" asp-controller="ProfileSettings" asp-action="Settings"><i class="bi bi-gear"></i> <span>Settings</span></a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main" id="main">
        <div class="top-navbar">
            <img src="~/images/logo_3-removebg-preview.png" alt="Thor Logo" class="img-fluid" style="height:50px;" />
            <div class="dropdown">
                <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-bell me-3 fs-5"></i>
                    <i class="bi bi-envelope me-3 fs-5"></i>
                    @userFirstName @userLastName
                    <img src="@profilePicSrc" alt="Profile Picture" class="rounded-circle ms-2" style="width:32px;height:32px;object-fit:cover;" />
                </a>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="profileDropdown">
                    <li><a class="dropdown-item" asp-controller="ProfileSettings" asp-action="Index"><i class="bi bi-gear me-2"></i> Settings</a></li>
                    <li><a class="dropdown-item" asp-controller="Home" asp-action="Index"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                </ul>
            </div>
        </div>

        <div class="content-area">
            @RenderBody()
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('collapse-icon');
            const main = document.getElementById('main');

            sidebar.classList.toggle('collapsed');
            main.classList.toggle('collapsed');

            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('bi-chevron-left');
                icon.classList.add('bi-chevron-right');
            } else {
                icon.classList.remove('bi-chevron-right');
                icon.classList.add('bi-chevron-left');
            }
        }
    </script>
</body>
</html>
