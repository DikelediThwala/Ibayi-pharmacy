@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "Pharmacy Manager Report";
    Layout = "_ManagerLayout";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container py-4" style="background-color: rgba(245, 245, 245, 0.6); border-radius: 10px; padding: 20px;">
    <h2 class="mb-4 text-center">📊 Stock Control Report</h2>
    <p class="text-muted text-center">
        Customize and generate detailed pharmacy stock take reports.
    </p>

    <form asp-action="GenerateReport" asp-controller="ManagerReport" method="post">
        <!-- Grouping Options -->
        <div class="mb-3">
            <label class="form-label fw-bold">📌 Group Report By</label>
            <select class="form-select" name="GroupBy" id="groupBySelect" required>
                <option value="">-- Select an option --</option>
                <option value="DosageForm">Dosage Form</option>
                <option value="Schedule">Schedule</option>
                <option value="Supplier">Supplier</option>
            </select>
        </div>

        <!-- Dynamic Filter -->
        <div class="mb-3" id="dynamicFilter" style="display:none;">
            <label class="form-label fw-bold" id="dynamicLabel"></label>
            <select class="form-select" name="FilterValue" id="dynamicSelect">
                <option value="">-- Select --</option>
            </select>
        </div>


        <!-- Medication Selection -->
        <div class="mb-3">
            <label class="form-label fw-bold">💊 Select Medications</label>
            <select multiple class="form-select" name="SelectedMedications">
                <option value="-1">All Medications</option>
                @foreach (var med in Model)
                {
                    <option value="@med.MedicineId">@med.MedicineName</option>
                }
            </select>
            <div class="form-text">Hold CTRL to select multiple medicines.</div>
        </div>

        <!-- Stock Level Filter -->
        <div class="mb-3">
            <label class="form-label fw-bold">⚙️ Stock Level</label>
            <select class="form-select" name="StockLevel">
                <option value="all">All</option>
                <option value="low">Below Reorder</option>
                <option value="out">Out of Stock</option>
            </select>
        </div>

        <!-- Report Date -->
        <div class="mb-3">
            <label class="form-label fw-bold"></label>
            <!-- Hidden Report Date -->
            <input type="hidden" name="ReportDate" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-success px-4">📄 Generate Report</button>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const medicines = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));

    const groupBySelect = document.getElementById('groupBySelect');
    const dynamicFilter = document.getElementById('dynamicFilter');
    const dynamicLabel = document.getElementById('dynamicLabel');
    const dynamicSelect = document.getElementById('dynamicSelect');

    groupBySelect.addEventListener('change', function () {
        const value = this.value;
        dynamicSelect.innerHTML = '<option value="">-- Select --</option>';

        if (value === "Supplier") {
            dynamicLabel.innerText = "Select Supplier";
            const suppliers = [...new Set(medicines.map(m => m.SupplierName).filter(s => s))];
            suppliers.forEach(s => dynamicSelect.innerHTML += `<option value="${s}">${s}</option>`);
            dynamicFilter.style.display = 'block';
        } else if (value === "DosageForm") {
            dynamicLabel.innerText = "Select Dosage Form";
            const forms = [...new Set(medicines.map(m => m.FormName).filter(f => f))];
            forms.forEach(f => dynamicSelect.innerHTML += `<option value="${f}">${f}</option>`);
            dynamicFilter.style.display = 'block';
        } else {
            dynamicFilter.style.display = 'none';
        }
    });
</script>
