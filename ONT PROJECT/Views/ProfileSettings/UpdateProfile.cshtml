@model ONT_PROJECT.Models.TblUser
@{
    ViewData["Title"] = "UPLOAD PRESCRIPTION";
    Layout = "_CustomerLayout";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h2 class="text-center mb-4">Edit Your Profile</h2>

            <form asp-action="UpdateProfile" method="post" enctype="multipart/form-data">
                <div class="form-group mb-3">
                    <label asp-for="FirstName"></label>
                    <input asp-for="FirstName" class="form-control" />
                    <span asp-validation-for="FirstName" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="LastName"></label>
                    <input asp-for="LastName" class="form-control" />
                    <span asp-validation-for="LastName" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="Idnumber"></label>
                    <input asp-for="Idnumber" class="form-control" />
                    <span asp-validation-for="Idnumber" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="PhoneNumber"></label>
                    <input asp-for="PhoneNumber" class="form-control" />
                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="Email"></label>
                    <input asp-for="Email" class="form-control" />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <!-- Allergies as a hidden input to post -->
                <input type="hidden" id="Allergies" name="Allergies" value="@Model.Allergies" />

                <div class="form-group mb-4">
                    <label>Allergies</label>
                    <div class="d-flex">
                        <select id="allergySelect" class="form-control me-2">
                            <option value="Penicillin">Penicillin</option>
                            <option value="Peanuts">Peanuts</option>
                            <option value="Dust">Dust</option>
                            <option value="Pollen">Pollen</option>
                            <option value="Gluten">Gluten</option>
                        </select>
                        <button type="button" class="btn btn-success" onclick="addAllergy()">Add</button>
                    </div>

                    <ul id="allergyList" class="list-group mt-2">
                        @if (!string.IsNullOrEmpty(Model.Allergies))
                        {
                            var allergies = Model.Allergies.Split(',');
                            foreach (var allergy in allergies)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    @allergy
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeAllergy(this)">Remove</button>
                                </li>
                            }
                        }
                    </ul>
                </div>

                <!-- Profile Picture Upload -->
                <div class="form-group mb-4">
                    <label for="ProfilePicture">Upload Profile Picture</label>
                    <input type="file" class="form-control" id="ProfilePicture" name="ProfilePicture" accept="image/*" />
                </div>

                <button type="submit" class="btn btn-primary w-100 text-uppercase">Save Changes</button>
            </form>
        </div>
    </div>
</div>

@* @section Scripts { *@
    <script>
        function addAllergy() {
            const select = document.getElementById("allergySelect");
            const selectedValue = select.value;

            const listItems = document.querySelectorAll("#allergyList li");
            for (let item of listItems) {
                if (item.textContent.includes(selectedValue)) {
                    alert("Allergy already added.");
                    return;
                }
            }

            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = selectedValue +
                '<button type="button" class="btn btn-sm btn-danger" onclick="removeAllergy(this)">Remove</button>';

            document.getElementById("allergyList").appendChild(li);
            updateAllergiesInput();
        }

        function removeAllergy(button) {
            button.parentElement.remove();
            updateAllergiesInput();
        }

        // Update hidden allergies input before submit
        function updateAllergiesInput() {
            const allergies = [];
            document.querySelectorAll("#allergyList li").forEach(li => {
                allergies.push(li.firstChild.textContent.trim());
            });
            document.getElementById("Allergies").value = allergies.join(",");
        }

        // Make sure allergies are updated before form submits
        document.querySelector("form").addEventListener("submit", function () {
            updateAllergiesInput();
        });
    </script>
}
