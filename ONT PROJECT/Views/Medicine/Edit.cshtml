@model ONT_PROJECT.Models.Medicine

@{
    ViewData["Title"] = "Edit Medicine";
    Layout = "_ManagerLayout";
}

<h2>Edit Medicine</h2>

<hr style="height: 4px; background-color: #011425; border: none;" />
<div class="alert alert-info shadow-sm d-flex align-items-center gap-2">
    <i class="bi bi-info-circle-fill"></i>
    Update Medicine details below. Fields marked with <span class="text-danger">*</span> are required.
</div>
<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.MedicineId)

    <div asp-validation-summary="All" class="text-danger mb-3"></div>

    <div class="row mb-3">
        <div class="col-md-6">
            <label asp-for="MedicineName" class="form-label">Medicine Name <span class="text-danger">*</span></label>
            <input asp-for="MedicineName" class="form-control" />
            <span asp-validation-for="MedicineName" class="text-danger small"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="Schedule" class="form-label">Schedule <span class="text-danger">*</span></label>
            <select asp-for="Schedule" class="form-select">
                <option value="">-- Select Schedule --</option>
                @for (int i = 0; i <= 6; i++)
                {
                    <option value="@i" selected="@(Model?.Schedule == i ? "selected" : null)">Schedule @i</option>
                }
            </select>
            <span asp-validation-for="Schedule" class="text-danger small"></span>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label">Ingredients <span class="text-danger">*</span></label>
            <table class="table table-bordered" id="ingredientsTable">
                <thead class="table-light">
                    <tr>
                        <th>Ingredient <span class="text-danger">*</span></th>
                        <th>Strength <span class="text-danger">*</span></th> <!-- Added strength header -->
                        <th style="width: 120px;">Action</th>
                    </tr>
                </thead>
                <tbody id="ingredientsTableBody">
                    @if (Model.MedIngredients != null && Model.MedIngredients.Any())
                    {
                        foreach (var medIngredient in Model.MedIngredients)
                        {
                            <tr>
                                <td>
                                    <select name="selectedIngredientIds[]" class="form-select" required>
                                        <option value="">-- Select Ingredient --</option>
                                        @foreach (var ingredient in (List<SelectListItem>)ViewBag.Ingredients)
                                        {
                                            var isSelected = ingredient.Value == medIngredient.ActiveIngredientId.ToString();
                                            <option value="@ingredient.Value" selected="@(isSelected ? "selected" : null)">
                                                @ingredient.Text
                                            </option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="text" name="strengths[]" class="form-control" required value="@medIngredient.Strength" />  <!-- Added strength input -->
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">
                                        <i class="bi bi-x-circle"></i> Remove
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td>
                                <select name="selectedIngredientIds[]" class="form-select" required>
                                    <option value="">-- Select Ingredient --</option>
                                    @foreach (var ingredient in (List<SelectListItem>)ViewBag.Ingredients)
                                    {
                                        <option value="@ingredient.Value">@ingredient.Text</option>
                                    }
                                </select>
                            </td>
                            <td>
                                <input type="text" name="strengths[]" class="form-control" required />  <!-- Added empty strength input -->
                            </td>
                            <td></td>
                        </tr>
                    }
                </tbody>
            </table>

            <button type="button" class="btn btn-outline-primary" onclick="addIngredientRow()">
                <i class="bi bi-plus-circle"></i> Add Ingredient
            </button>
        </div>

        <div class="col-md-6">
            <label asp-for="SalesPrice" class="form-label">Sales Price <span class="text-danger">*</span></label>
            <input asp-for="SalesPrice" class="form-control" type="number" step="0.01" />
            <span asp-validation-for="SalesPrice" class="text-danger small"></span>
        </div>

    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <label asp-for="ReorderLevel" class="form-label">Reorder Level</label>
            <input asp-for="ReorderLevel" class="form-control" type="number" step="1" />
            <span asp-validation-for="ReorderLevel" class="text-danger small"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="Quantity" class="form-label">Quantity</label>
            <input asp-for="Quantity" class="form-control" type="number" step="1" />
            <span asp-validation-for="Quantity" class="text-danger small"></span>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <label asp-for="FormId" class="form-label">Form Name <span class="text-danger">*</span></label>
            <select asp-for="FormId" class="form-select" asp-items="ViewBag.Forms">
                <option value="">-- Select Form --</option>
            </select>
            <span asp-validation-for="FormId" class="text-danger small"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="SupplierId" class="form-label">Supplier <span class="text-danger">*</span></label>
            <select asp-for="SupplierId" class="form-select" asp-items="ViewBag.Suppliers">
                <option value="">-- Select Supplier --</option>
            </select>
            <span asp-validation-for="SupplierId" class="text-danger small"></span>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <a asp-action="Index" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Save
        </button>
    </div>
</form>

@section Scripts {
    <script>
        const ingredients = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.Ingredients));

        function addIngredientRow() {
            const tableBody = document.getElementById("ingredientsTableBody");
            const newRow = document.createElement("tr");

            let options = `<option value="">-- Select Ingredient --</option>`;
            ingredients.forEach(i => {
                options += `<option value="${i.value}">${i.text}</option>`;
            });

            newRow.innerHTML = `
                <td>
                    <select name="selectedIngredientIds[]" class="form-select" required>
                        ${options}
                    </select>
                </td>
                <td>
                    <input type="text" name="strengths[]" class="form-control" required />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">
                        <i class="bi bi-x-circle"></i> Remove
                    </button>
                </td>
            `;

            tableBody.appendChild(newRow);
        }

        function removeRow(button) {
            button.closest('tr').remove();
        }
    </script>
}
