@model ONT_PROJECT.Models.BOrder
@using Microsoft.AspNetCore.Mvc.Rendering

@{

    var medications = ViewBag.Medications as List<SelectListItem> ?? new List<SelectListItem>();
    var medDetails = ViewBag.MedicationDetails as List<ONT_PROJECT.Models.Medicine>;
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Varela+Round">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
    .table-wrapper {
        background: #fff;
        padding: 20px 25px;
        border-radius: 3px;
        box-shadow: 0 1px 1px rgba(0,0,0,.05);
        font-family: 'Varela Round', sans-serif;
        font-size: 13px;
    }

    .table-title {
        color: #fff;
        background: #4b5366;
        padding: 16px 25px;
        margin: -20px -25px 10px;
        border-radius: 3px 3px 0 0;
    }

    table.table tr th, table.table tr td {
        border-color: #e9e9e9;
        padding: 12px 15px;
        vertical-align: middle;
    }

    table.table-striped tbody tr:nth-of-type(odd) {
        background-color: #fcfcfc;
    }

    table.table-striped.table-hover tbody tr:hover {
        background: #f5f5f5;
    }

    table.table td input.form-control {
        font-size: 13px;
        padding: 4px 8px;
        height: 30px;
    }

    .table-warning {
        background-color: #ffe5b4 !important;
    }

    .table-primary {
        background-color: #dbe9f7 !important;
    }

    /* Scrollable table wrapper */
    #orderTableWrapper {
        max-height: 540px; /* approx 8 rows */
        overflow-y: auto;
        display: block;
    }

    /* Sticky header */
    #orderTable thead th {
        position: sticky;
        top: 0;
        background: #4b5366;
        color: white;
        z-index: 1;
    }
</style>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<div class="container-xl">
    <div class="table-wrapper">
        <div class="alert alert-info mt-3 mb-4" role="alert">
            <strong>Note:</strong><br />
            <span class="badge text-dark" style="background-color: #ffe5b4;">Light orange rows</span> = Quantity is below or at reorder level.<br />
            <span class="badge bg-primary text-dark">Primary rows</span> = Quantity is within 5 units of reorder level.<br />
            White rows = Stock is sufficient.
        </div>
        <br />
        <br />
      
        <div class="table-title">
            <div class="row">
                <div class="col-sm-6">
                    <h2><i class="fas fa-pills"></i> Create <b>Medication Order</b></h2>
                </div>
                <div class="col-sm-6 text-end">
                    <button type="button" class="btn btn-primary" onclick="selectLowStockAndSubmit()">
                        <i class="material-icons">&#xE147;</i> <span>Order Low stock </span>
                    </button>
                </div>
            </div>
        </div>

        <form asp-action="Create" asp-controller="B_Order" method="post" id="orderForm">
            @Html.AntiForgeryToken()
            <div id="orderTableWrapper">
                <table id="orderTable" class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="selectAll" /></th>
                            <th>Medication</th>
                            <th>Quantity in Hand</th>
                            <th>Reorder Level</th>
                            <th>Price</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < medications.Count; i++)
                        {
                            var medId = int.Parse(medications[i].Value);
                            var med = medDetails?.FirstOrDefault(m => m.MedicineId == medId);

                            <tr class="@(med != null && med.Quantity <= med.ReorderLevel ? "table-warning" : "")">
                                <td class="text-center">
                                    <input type="checkbox" name="BOrderLines[@i].IsSelected" value="true" class="medCheck" />
                                    <input type="hidden" name="BOrderLines[@i].MedicineId" value="@medications[i].Value" />
                                </td>
                                <td>@medications[i].Text</td>
                                <td>@med?.Quantity</td>
                                <td>@med?.ReorderLevel</td>
                                <td>R @med?.SalesPrice ,00</td>

                                <td>
                                    <input type="number" name="BOrderLines[@i].Quantity" class="form-control qtyInput" value="100" min="100" disabled />
                                </td>
                            </tr>
                        }



                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end mt-3">
                <button type="button" id="openOrderSummaryBtn" class="btn btn-success">Submit Order</button>
            </div>
        </form>
    </div>
</div>

<!-- Order Summary Modal -->
<div class="modal fade" id="orderSummaryModal" tabindex="-1" aria-labelledby="orderSummaryLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderSummaryLabel">Confirm Your Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Medication</th>
                            <th>Quantity</th>
                            <th>Price per Unit</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="orderSummaryBody"></tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" class="text-end">Total:</th>
                            <th id="orderTotalPrice">0.00</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmOrderBtn" class="btn btn-success">Confirm Order</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Convert C# MedicationPrices dictionary to JS object
    const medicationPrices = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
                ViewBag.MedicationPrices ?? new Dictionary<int, double>()
        ));

    // Select/Deselect all checkboxes
    $('#selectAll').click(function () {
        const checked = $(this).prop('checked');
        $('.medCheck').prop('checked', checked).trigger('change');
    });

    // Enable quantity input only if checkbox is checked
    $('.medCheck').change(function () {
        $(this).closest('tr').find('.qtyInput').prop('disabled', !this.checked);
    });

    // Open order summary modal
    $('#openOrderSummaryBtn').click(function () {
        const tbody = $('#orderSummaryBody');
        tbody.empty();
        let totalPrice = 0;
        const selectedRows = $('.medCheck:checked');

        if (selectedRows.length === 0) {
            Swal.fire({
                icon: "warning",
                title: "No Medications Selected",
                text: "Please select at least one medication."
            });
            return;
        }

        selectedRows.each(function () {
            const tr = $(this).closest('tr');
            const medId = tr.find('input[name$=".MedicineId"]').val();
            const qty = parseInt(tr.find('.qtyInput').val());
            const medName = tr.children().eq(1).text();
            const price = medicationPrices[medId] || 0;
            const subtotal = qty * price;
            totalPrice += subtotal;

            tbody.append(`
                <tr>
                    <td>${medName}</td>
                    <td>${qty}</td>
                    <td>${price.toFixed(2)}</td>
                    <td>${subtotal.toFixed(2)}</td>
                </tr>
            `);
        });

        $('#orderTotalPrice').text(totalPrice.toFixed(2));

        var orderModal = new bootstrap.Modal(document.getElementById('orderSummaryModal'));
        orderModal.show();

        // Confirm order with AJAX + SweetAlert
        $('#confirmOrderBtn').off('click').on('click', function () {
            orderModal.hide();

            // 🔹 Show loading state before AJAX request
            Swal.fire({
                title: "Submitting Order...",
                text: "Please wait while we process your order.",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: $('#orderForm').attr('action'),
                type: "POST",
                data: $('#orderForm').serialize(),
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: "success",
                            title: "Success!",
                            text: response.message
                        }).then(() => {
                            window.location.href = "/B_Order/Index?tab=orders";
                        });
                    } else {
                        Swal.fire({
                            icon: "warning",
                            title: "Warning",
                            text: response.message
                        });
                    }
                },
                error: function (xhr) {
                    let errorMsg = xhr.responseJSON?.message || "An unexpected error occurred.";
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: errorMsg
                    });
                }
            });
        });
    });

           function selectLowStockAndSubmit() {
        // Uncheck everything first
        $('.medCheck').prop('checked', false).trigger('change');

        // Select rows where quantity <= reorder level
        $('#orderTable tbody tr').each(function () {
            const qty = parseInt($(this).children().eq(2).text());   // Quantity in Hand
            const reorder = parseInt($(this).children().eq(3).text()); // Reorder Level

            if (!isNaN(qty) && !isNaN(reorder) && qty <= reorder) {
                const checkbox = $(this).find('.medCheck');
                const qtyInput = $(this).find('.qtyInput');

                checkbox.prop('checked', true).trigger('change');
                qtyInput.prop('disabled', false);   // ✅ enable input so it gets posted
            }
        });

        // Trigger the same logic as "Submit Order" button
        $('#openOrderSummaryBtn').trigger('click');
    }

</script>
