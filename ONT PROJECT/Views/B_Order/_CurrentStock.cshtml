@model List<ONT_PROJECT.Models.Medicine>

<h5>Current Stock Levels</h5>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-dark fw-bold"><i class="fas fa-users-cog"></i> Manage Medication Stock</h2>
</div>

<hr class="mb-5" style="height: 4px; background-color: #011425; border: none;" />

<div class="alert alert-info mt-3 mb-4" role="alert">
    <strong>Note:</strong>
    <span class="badge text-dark" style="background-color: #ffe5b4;">Light orange rows</span> = Quantity is below or at reorder level. <br />
    <span class="badge bg-primary text-dark">Primary rows</span> = Quantity is within 5 units of reorder level (approaching low). <br />
    White rows = Stock is sufficient.
</div>

<form method="post" action="/B_Order/Selected" id="medForm">
    <table class="table table-bordered table-hover">
        <thead class="table-dark">
            <tr>
                <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)" /></th>
                <th>Name</th>
                <th>Quantity</th>
                <th>Reorder Level</th>
                <th>Stock Control</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Count; i++)
            {
                var med = Model[i];
                var rowClass = med.Quantity <= med.ReorderLevel ? "table-warning"
                : med.Quantity <= med.ReorderLevel + 5 ? "table-primary"
                : "";

                <tr class="@rowClass">
                    <td><input type="checkbox" name="selectedMedIds" value="@med.MedicineId" class="med-checkbox @(med.Quantity <= med.ReorderLevel ? "low-stock" : "")" /></td>
                    <td>@med.MedicineName</td>
                    <td>
                        <input type="number" name="quantities" value="@med.Quantity" class="form-control mb-1" readonly />
                    </td>
                    <td><input type="number" class="form-control text-center" value="@med.ReorderLevel" readonly /></td>
                    <td>
                        <input type="number" name="increments" placeholder="+ Add" min="0" class="form-control mb-1" />
                        <button type="button" class="btn btn-sm btn-success" onclick="updateStock(@med.MedicineId, this)">Update</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button type="submit" class="btn btn-success me-2">Add to B-Order</button>
    <button type="button" class="btn btn-danger" onclick="selectLowStockAndSubmit()">Auto-Select Low Stock</button>
</form>

@section Scripts {
    <script>
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll(".med-checkbox");
            checkboxes.forEach(chk => chk.checked = source.checked);
        }

        function selectLowStockAndSubmit() {
            const lowStockCheckboxes = document.querySelectorAll(".low-stock");
            lowStockCheckboxes.forEach(chk => chk.checked = true);
            document.getElementById("medForm").submit();
        }

        async function updateStock(medicineId, btn) {
            const row = btn.closest("tr");
            const incrementInput = row.querySelector('input[name="increments"]');
            const quantityInput = row.querySelector('input[name="quantities"]');

            const increment = parseInt(incrementInput.value);
            if (isNaN(increment) || increment <= 0) {
                alert("Please enter a valid increment amount.");
                return;
            }

            const response = await fetch('/Medicine/UpdateStock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ medicineId: medicineId, increment: increment })
            });

            if (response.ok) {
                const data = await response.json();
                quantityInput.value = data.newQuantity;
                incrementInput.value = '';
            } else {
                alert("Failed to update stock.");
            }
        }
    </script>
}









@* 
<h5>Current Stock Levels</h5>
@model List<ONT_PROJECT.Models.Medicine>
@{
    ViewData["Title"] = "Manage Medication Stock";
    Layout = "_ManagerLayout";
}



<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-dark fw-bold"><i class="fas fa-users-cog"></i> Manage Medication Stock</h2>

</div>

<hr class="mb-5" style="height: 4px; background-color: #011425; border: none;" />

<div class="alert alert-info mt-3 mb-4" role="alert">
    <strong>Note:</strong>
    <span class="badge text-dark" style="background-color: #ffe5b4;">Light orange rows</span> = Quantity is below or at reorder level. <br />
    <span class="badge bg-primary text-dark">Primary rows</span> = Quantity is within 5 units of reorder level (approaching low). <br />
    White rows = Stock is sufficient.
</div>


<form method="post" action="/B_Order/Selected" id="medForm">
    <table class="table table-bordered table-hover">
        <thead class="table-dark">
            <tr>
                <th><input type="checkbox" id="selectAll" onclick="toggleAll(this)" /></th>
                <th>Name</th>
                <th>Quantity</th>
                <th>Reorder Level</th>
                <th>Stock Control</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Count; i++)
            {
                var med = Model[i];
                var rowClass = med.Quantity <= med.ReorderLevel ? "table-warning"
                : med.Quantity <= med.ReorderLevel + 5 ? "table-primary"
                : "";

                <tr class="@rowClass">
                    <td><input type="checkbox" name="selectedMedIds" value="@med.MedicineId" class="med-checkbox @(med.Quantity <= med.ReorderLevel ? "low-stock" : "")" /></td>
                    <td>@med.MedicineName</td>
                    <td>
                        <input type="number" name="quantities" value="@med.Quantity" class="form-control mb-1" readonly />
                    </td>
                    <td><input type="number" class="form-control text-center" value="@med.ReorderLevel" readonly /></td>
                    <td>
                        <input type="number" name="increments" placeholder="+ Add" min="0" class="form-control mb-1" />
                        <button type="button" class="btn btn-sm btn-success" onclick="updateStock(@med.MedicineId, this)">Update</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <button type="submit" class="btn btn-success me-2">Add to B-Order</button>
    <button type="button" class="btn btn-danger" onclick="selectLowStockAndSubmit()">Auto-Select Low Stock</button>
</form>

@section Scripts {
    <script>
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll(".med-checkbox");
            checkboxes.forEach(chk => chk.checked = source.checked);
        }

        function selectLowStockAndSubmit() {
            const lowStockCheckboxes = document.querySelectorAll(".low-stock");
            lowStockCheckboxes.forEach(chk => chk.checked = true);
            document.getElementById("medForm").submit();
        }

        async function updateStock(medicineId, btn) {
            const row = btn.closest("tr");
            const incrementInput = row.querySelector('input[name="increments"]');
            const quantityInput = row.querySelector('input[name="quantities"]');

            const increment = parseInt(incrementInput.value);
            if (isNaN(increment) || increment <= 0) {
                alert("Please enter a valid increment amount.");
                return;
            }

            const response = await fetch('/Medicine/UpdateStock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ medicineId: medicineId, increment: increment })
            });

            if (response.ok) {
                const data = await response.json();
                quantityInput.value = data.newQuantity;
                incrementInput.value = '';
            } else {
                alert("Failed to update stock.");
            }
        }
    </script>
}

 *@